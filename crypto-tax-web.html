<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Tax Tracking Spreadsheet - Pro Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #141414;
            --bg-tertiary: #1a1a1a;
            --bg-card: #1f1f1f;
            --bg-hover: #2a2a2a;
            --border-color: #333;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --text-muted: #707070;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-purple: #8b5cf6;
            --accent-yellow: #f59e0b;
            --accent-cyan: #06b6d4;
            --gradient-primary: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #06b6d4 100%);
            --gradient-danger: linear-gradient(135deg, #ef4444 0%, #f59e0b 100%);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--bg-secondary);
            min-height: 100vh;
        }

        .header {
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .tabs {
            display: flex;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .tab {
            padding: 16px 24px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.3s;
            position: relative;
            white-space: nowrap;
            border-bottom: 2px solid transparent;
        }

        .tab:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .tab.active {
            color: var(--accent-blue);
            background: var(--bg-secondary);
            border-bottom-color: var(--accent-blue);
        }

        .sheet {
            display: none;
            padding: 24px;
            min-height: calc(100vh - 140px);
            animation: fadeIn 0.3s ease;
        }

        .sheet.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .toolbar {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 12px;
            align-items: center;
            flex-wrap: wrap;
            border: 1px solid var(--border-color);
        }

        button {
            padding: 10px 20px;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(-100%);
            transition: transform 0.3s;
        }

        button:hover::before {
            transform: translateX(0);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        button.secondary {
            background: var(--gradient-success);
        }

        button.secondary:hover {
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        button.danger {
            background: var(--gradient-danger);
        }

        button.danger:hover {
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        button.outline {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        button.outline:hover {
            background: var(--bg-hover);
            box-shadow: none;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-icon {
            width: 20px;
            height: 20px;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 13px;
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        th {
            background: var(--bg-tertiary);
            padding: 14px 12px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid rgba(51, 51, 51, 0.5);
            color: var(--text-primary);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background: var(--bg-hover);
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            color: var(--text-primary);
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            background: var(--bg-secondary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 24px;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .summary-card.green::before {
            background: var(--gradient-success);
        }

        .summary-card.red::before {
            background: var(--gradient-danger);
        }

        .summary-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        }

        .summary-card h3 {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-card .value {
            font-size: 28px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .summary-card .change {
            font-size: 12px;
            margin-top: 8px;
            color: var(--text-secondary);
        }

        .positive {
            color: var(--accent-green) !important;
        }

        .negative {
            color: var(--accent-red) !important;
        }

        .info-box {
            background: var(--bg-card);
            border-left: 4px solid var(--accent-blue);
            padding: 16px 20px;
            margin-bottom: 24px;
            border-radius: 8px;
        }

        .info-box h4 {
            color: var(--text-primary);
            margin-bottom: 6px;
            font-size: 16px;
        }

        .info-box p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 32px;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 24px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .button-group {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 28px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.untouched {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
        }

        .status-badge.partial {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-yellow);
        }

        .status-badge.depleted {
            background: rgba(107, 114, 128, 0.2);
            color: var(--text-muted);
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .file-input-label:hover {
            background: var(--bg-hover);
            border-color: var(--accent-blue);
        }

        .stats-row {
            display: flex;
            gap: 16px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .stat-item {
            flex: 1;
            min-width: 150px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            text-align: center;
        }

        .stat-item .label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-item .value {
            font-size: 20px;
            font-weight: bold;
            color: var(--text-primary);
            margin-top: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .empty-state p {
            margin-bottom: 20px;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-hover);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border-color);
        }

        @media (max-width: 768px) {
            .header {
                padding: 16px;
            }
            
            .tabs {
                overflow-x: auto;
            }
            
            .tab {
                padding: 12px 16px;
                font-size: 13px;
            }

            .sheet {
                padding: 16px;
            }

            table {
                font-size: 11px;
            }

            th, td {
                padding: 8px;
            }

            .modal-content {
                padding: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <span style="font-size: 28px;">üíé</span>
                Crypto Tax Tracker Pro
            </h1>
            <div class="header-controls">
                <span style="color: var(--text-secondary); margin-right: 20px;">Tax Year: 2024</span>
                <div class="file-input-wrapper">
                    <input type="file" id="importFile" accept=".json" onchange="importData(event)">
                    <label for="importFile" class="file-input-label">
                        üìÇ Import Data
                    </label>
                </div>
                <button onclick="exportToJSON()">üíæ Export Data</button>
                <button onclick="exportToCSV()" class="secondary">üìä Export Tax Report</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('transactions')">üìù Transactions</button>
            <button class="tab" onclick="switchTab('lots')">üì¶ Tax Lots</button>
            <button class="tab" onclick="switchTab('disposals')">üí∞ Disposals</button>
            <button class="tab" onclick="switchTab('summary')">üìà Summary</button>
            <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
        </div>

        <!-- Transactions Sheet -->
        <div id="transactions" class="sheet active">
            <div class="toolbar">
                <button onclick="showTransactionModal()">‚ûï Add Transaction</button>
                <button class="secondary" onclick="recalculateAll()">üîÑ Recalculate All</button>
                <button class="danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                <span style="margin-left: auto; color: var(--text-secondary);">
                    Total Transactions: <span id="transactionCount" style="color: var(--accent-blue); font-weight: bold;">0</span>
                </span>
            </div>
            
            <div style="overflow-x: auto;">
                <table id="transactionsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Coin</th>
                            <th>Quantity</th>
                            <th>USD Amount</th>
                            <th>Fees</th>
                            <th>Per Unit</th>
                            <th>Exchange</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsBody">
                    </tbody>
                </table>
                <div id="transactionsEmpty" class="empty-state" style="display: none;">
                    <svg fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 1 1 0 000 2H6a2 2 0 100 4h2a2 2 0 100-4h-.5a1 1 0 000-2H8a2 2 0 012-2v1h2v-1a2 2 0 112 2h-.5a1 1 0 000 2H14a2 2 0 010 4h-2a2 2 0 010-4h.5a1 1 0 000-2H12a2 2 0 01-2-2V2z" clip-rule="evenodd"></path>
                    </svg>
                    <h3>No Transactions Yet</h3>
                    <p>Start by adding your first crypto transaction</p>
                    <button onclick="showTransactionModal()">‚ûï Add First Transaction</button>
                </div>
            </div>
        </div>

        <!-- Tax Lots Sheet -->
        <div id="lots" class="sheet">
            <div class="info-box">
                <h4>üì¶ Tax Lot Tracking</h4>
                <p>Automatically tracks all acquisition lots using FIFO method. Each purchase, trade-in, or income transaction creates a new lot.</p>
            </div>
            
            <div class="stats-row">
                <div class="stat-item">
                    <div class="label">Total Lots</div>
                    <div class="value" id="totalLots">0</div>
                </div>
                <div class="stat-item">
                    <div class="label">Active Lots</div>
                    <div class="value" id="activeLots">0</div>
                </div>
                <div class="stat-item">
                    <div class="label">Depleted Lots</div>
                    <div class="value" id="depletedLots">0</div>
                </div>
                <div class="stat-item">
                    <div class="label">Total Cost Basis</div>
                    <div class="value" id="totalCostBasis">$0</div>
                </div>
            </div>
            
            <div style="overflow-x: auto;">
                <table id="lotsTable">
                    <thead>
                        <tr>
                            <th>Lot ID</th>
                            <th>Date</th>
                            <th>Coin</th>
                            <th>Original Qty</th>
                            <th>Cost Basis</th>
                            <th>Per Unit</th>
                            <th>Qty Sold</th>
                            <th>Remaining</th>
                            <th>Status</th>
                            <th>Unrealized P/L</th>
                        </tr>
                    </thead>
                    <tbody id="lotsBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Disposals Sheet -->
        <div id="disposals" class="sheet">
            <div class="info-box">
                <h4>üí∞ Disposal Tracking</h4>
                <p>All sales and trades with automatic FIFO lot matching and gain/loss calculation.</p>
            </div>
            
            <div class="stats-row">
                <div class="stat-item">
                    <div class="label">Total Sales</div>
                    <div class="value" id="totalSales">0</div>
                </div>
                <div class="stat-item">
                    <div class="label">Total Proceeds</div>
                    <div class="value" id="totalProceeds">$0</div>
                </div>
                <div class="stat-item">
                    <div class="label">Total Gains</div>
                    <div class="value" id="totalGains" class="positive">$0</div>
                </div>
                <div class="stat-item">
                    <div class="label">Total Losses</div>
                    <div class="value" id="totalLosses" class="negative">$0</div>
                </div>
            </div>
            
            <div style="overflow-x: auto;">
                <table id="disposalsTable">
                    <thead>
                        <tr>
                            <th>Sale ID</th>
                            <th>Sale Date</th>
                            <th>Lot ID</th>
                            <th>Acquired</th>
                            <th>Coin</th>
                            <th>Qty</th>
                            <th>Proceeds</th>
                            <th>Cost Basis</th>
                            <th>Gain/Loss</th>
                            <th>Days</th>
                            <th>Term</th>
                        </tr>
                    </thead>
                    <tbody id="disposalsBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Summary Sheet -->
        <div id="summary" class="sheet">
            <h2 style="margin-bottom: 24px; color: var(--text-primary);">üìä Tax Year 2024 Summary</h2>
            
            <div class="summary-grid">
                <div class="summary-card">
                    <h3>Short-Term Capital Gains</h3>
                    <div class="value" id="shortTermGains">$0.00</div>
                    <div class="change">Tax Rate: <span id="stRateDisplay">37%</span></div>
                </div>
                <div class="summary-card green">
                    <h3>Long-Term Capital Gains</h3>
                    <div class="value" id="longTermGains">$0.00</div>
                    <div class="change">Tax Rate: <span id="ltRateDisplay">20%</span></div>
                </div>
                <div class="summary-card">
                    <h3>Crypto Income</h3>
                    <div class="value" id="totalIncome">$0.00</div>
                    <div class="change">Mining, Staking, Airdrops</div>
                </div>
                <div class="summary-card red">
                    <h3>Estimated Tax Liability</h3>
                    <div class="value" id="taxLiability">$0.00</div>
                    <div class="change">Federal + State</div>
                </div>
            </div>

            <h3 style="margin: 32px 0 20px; color: var(--text-primary);">üíº Current Holdings</h3>
            <div style="overflow-x: auto;">
                <table id="holdingsTable">
                    <thead>
                        <tr>
                            <th>Coin</th>
                            <th>Quantity</th>
                            <th>Avg Cost</th>
                            <th>Total Cost</th>
                            <th>Current Price</th>
                            <th>Market Value</th>
                            <th>Unrealized P/L</th>
                            <th>Change %</th>
                        </tr>
                    </thead>
                    <tbody id="holdingsBody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Settings Sheet -->
        <div id="settings" class="sheet">
            <div class="info-box">
                <h4>‚öôÔ∏è Configuration Settings</h4>
                <p>Configure tax rates, supported coins, and calculation methods.</p>
            </div>

            <div style="max-width: 600px;">
                <h3 style="margin-bottom: 20px; color: var(--text-primary);">Tax Configuration</h3>
                
                <div class="form-group">
                    <label>Short-Term Capital Gains Tax Rate (%)</label>
                    <input type="number" id="shortTermRate" value="37" min="0" max="100" step="0.1">
                </div>
                
                <div class="form-group">
                    <label>Long-Term Capital Gains Tax Rate (%)</label>
                    <input type="number" id="longTermRate" value="20" min="0" max="100" step="0.1">
                </div>

                <div class="form-group">
                    <label>State Tax Rate (%)</label>
                    <input type="number" id="stateRate" value="0" min="0" max="20" step="0.1">
                </div>

                <div class="form-group">
                    <label>Cost Basis Method</label>
                    <select id="costBasisMethod">
                        <option value="FIFO">FIFO (First In First Out)</option>
                        <option value="LIFO">LIFO (Last In First Out)</option>
                        <option value="HIFO">HIFO (Highest In First Out)</option>
                    </select>
                </div>

                <button onclick="saveSettings()">üíæ Save Settings</button>
            </div>

            <h3 style="margin: 32px 0 20px; color: var(--text-primary);">üíµ Current Market Prices</h3>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">Update these prices to calculate unrealized gains</p>
            <div id="priceSettings" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px;">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span style="font-size: 28px;">‚ûï</span>
                Add New Transaction
            </div>
            
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="txDate" required>
            </div>

            <div class="form-group">
                <label>Transaction Type</label>
                <select id="txType" onchange="updateFormFields()">
                    <option value="Buy">Buy (Fiat Purchase)</option>
                    <option value="Sell">Sell (Fiat Sale)</option>
                    <option value="Trade">Trade (Crypto-to-Crypto)</option>
                    <option value="Income">Income (Payment)</option>
                    <option value="Mining">Mining Reward</option>
                    <option value="Staking">Staking Reward</option>
                    <option value="Airdrop">Airdrop</option>
                    <option value="Gift Received">Gift Received</option>
                    <option value="Gift Given">Gift Given</option>
                    <option value="Transfer">Transfer (Non-Taxable)</option>
                </select>
            </div>

            <div class="form-group">
                <label>Cryptocurrency</label>
                <select id="txCoin">
                    <option value="BTC">Bitcoin (BTC)</option>
                    <option value="ETH">Ethereum (ETH)</option>
                    <option value="SOL">Solana (SOL)</option>
                    <option value="ADA">Cardano (ADA)</option>
                    <option value="DOT">Polkadot (DOT)</option>
                    <option value="MATIC">Polygon (MATIC)</option>
                    <option value="LINK">Chainlink (LINK)</option>
                    <option value="AVAX">Avalanche (AVAX)</option>
                    <option value="ATOM">Cosmos (ATOM)</option>
                    <option value="XRP">Ripple (XRP)</option>
                </select>
            </div>

            <div class="form-group">
                <label>Quantity</label>
                <input type="number" id="txQuantity" step="0.00000001" placeholder="0.00000000" required>
            </div>

            <div class="form-group">
                <label>USD Amount</label>
                <input type="number" id="txAmount" step="0.01" placeholder="0.00" required>
            </div>

            <div class="form-group">
                <label>Transaction Fees (USD)</label>
                <input type="number" id="txFees" step="0.01" value="0" placeholder="0.00">
            </div>

            <div class="form-group" id="tradeFields" style="display: none;">
                <label>Received Cryptocurrency</label>
                <select id="txTradeCoin">
                    <option value="">Select cryptocurrency received</option>
                    <option value="BTC">Bitcoin (BTC)</option>
                    <option value="ETH">Ethereum (ETH)</option>
                    <option value="SOL">Solana (SOL)</option>
                    <option value="ADA">Cardano (ADA)</option>
                    <option value="DOT">Polkadot (DOT)</option>
                </select>
                <label style="margin-top: 12px;">Received Quantity</label>
                <input type="number" id="txTradeQty" step="0.00000001" placeholder="0.00000000">
            </div>

            <div class="form-group">
                <label>Exchange/Wallet</label>
                <select id="txExchange">
                    <option value="Coinbase">Coinbase</option>
                    <option value="Binance">Binance</option>
                    <option value="Kraken">Kraken</option>
                    <option value="MetaMask">MetaMask</option>
                    <option value="Hardware">Hardware Wallet</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="form-group">
                <label>Transaction Notes</label>
                <textarea id="txNotes" rows="2" placeholder="Optional notes about this transaction"></textarea>
            </div>

            <div class="button-group">
                <button onclick="closeModal()" class="outline">Cancel</button>
                <button onclick="addTransaction()">Add Transaction</button>
            </div>
        </div>
    </div>

    <script>
        // Data storage with versioning for future compatibility
        let appData = {
            version: '1.0.0',
            transactions: [],
            lots: [],
            disposals: [],
            settings: {
                shortTermRate: 37,
                longTermRate: 20,
                stateRate: 0,
                costBasisMethod: 'FIFO'
            },
            currentPrices: {
                BTC: 45000,
                ETH: 2500,
                SOL: 100,
                ADA: 0.50,
                DOT: 7.50,
                MATIC: 0.90,
                LINK: 15,
                AVAX: 35,
                ATOM: 10,
                XRP: 0.60
            },
            metadata: {
                lastModified: new Date().toISOString(),
                taxYear: 2024
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadFromLocalStorage();
            updateAllTables();
            updateSummary();
        });

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.sheet').forEach(sheet => {
                sheet.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'summary') {
                updateSummary();
            } else if (tabName === 'lots') {
                updateLotStats();
            } else if (tabName === 'disposals') {
                updateDisposalStats();
            }
        }

        // Modal functions
        function showTransactionModal() {
            document.getElementById('transactionModal').classList.add('active');
            document.getElementById('txDate').value = new Date().toISOString().split('T')[0];
        }

        function closeModal() {
            document.getElementById('transactionModal').classList.remove('active');
        }

        function updateFormFields() {
            const type = document.getElementById('txType').value;
            const tradeFields = document.getElementById('tradeFields');
            
            if (type === 'Trade') {
                tradeFields.style.display = 'block';
            } else {
                tradeFields.style.display = 'none';
            }
        }

        // Add transaction
        function addTransaction() {
            const date = document.getElementById('txDate').value;
            const type = document.getElementById('txType').value;
            const coin = document.getElementById('txCoin').value;
            const quantity = parseFloat(document.getElementById('txQuantity').value);
            const amount = parseFloat(document.getElementById('txAmount').value);
            const fees = parseFloat(document.getElementById('txFees').value) || 0;
            const exchange = document.getElementById('txExchange').value;
            const notes = document.getElementById('txNotes').value;
            
            if (!date || !quantity || !amount) {
                alert('Please fill in all required fields');
                return;
            }

            const transaction = {
                id: appData.transactions.length + 1,
                date: date,
                timestamp: new Date().toISOString(),
                type: type,
                coin: coin,
                quantity: quantity,
                amount: amount,
                fees: fees,
                perUnit: (amount + fees) / quantity,
                exchange: exchange,
                notes: notes
            };

            if (type === 'Trade') {
                const tradeCoin = document.getElementById('txTradeCoin').value;
                const tradeQty = parseFloat(document.getElementById('txTradeQty').value);
                
                if (tradeCoin && tradeQty) {
                    transaction.type = 'Sell';
                    appData.transactions.push(transaction);
                    
                    const buyTransaction = {
                        id: appData.transactions.length + 1,
                        date: date,
                        timestamp: new Date().toISOString(),
                        type: 'Buy',
                        coin: tradeCoin,
                        quantity: tradeQty,
                        amount: amount,
                        fees: 0,
                        perUnit: amount / tradeQty,
                        exchange: exchange,
                        notes: 'Trade: ' + coin + ' ‚Üí ' + tradeCoin
                    };
                    appData.transactions.push(buyTransaction);
                }
            } else {
                appData.transactions.push(transaction);
            }

            processTransaction(transaction);
            updateAllTables();
            updateSummary();
            saveToLocalStorage();
            closeModal();
        }

        // Process transaction for lots and disposals
        function processTransaction(tx) {
            const isAcquisition = ['Buy', 'Income', 'Mining', 'Staking', 'Airdrop', 'Gift Received'].includes(tx.type);
            const isDisposal = ['Sell', 'Gift Given'].includes(tx.type);

            if (isAcquisition) {
                const lot = {
                    id: `${tx.coin}-${tx.date.replace(/-/g, '')}-${tx.id}`,
                    transactionId: tx.id,
                    date: tx.date,
                    coin: tx.coin,
                    originalQty: tx.quantity,
                    costBasis: tx.amount + tx.fees,
                    perUnitCost: (tx.amount + tx.fees) / tx.quantity,
                    qtySold: 0,
                    remaining: tx.quantity,
                    status: 'Untouched',
                    type: tx.type
                };
                appData.lots.push(lot);
            } else if (isDisposal) {
                let qtyToSell = tx.quantity;
                const proceeds = tx.amount - tx.fees;
                
                const availableLots = appData.lots
                    .filter(lot => lot.coin === tx.coin && lot.remaining > 0 && lot.date <= tx.date)
                    .sort((a, b) => {
                        if (appData.settings.costBasisMethod === 'LIFO') {
                            return new Date(b.date) - new Date(a.date);
                        } else if (appData.settings.costBasisMethod === 'HIFO') {
                            return b.perUnitCost - a.perUnitCost;
                        }
                        return new Date(a.date) - new Date(b.date); // FIFO default
                    });

                for (const lot of availableLots) {
                    if (qtyToSell <= 0) break;
                    
                    const qtyFromThisLot = Math.min(qtyToSell, lot.remaining);
                    const costBasis = qtyFromThisLot * lot.perUnitCost;
                    const proceedsFromThisLot = (qtyFromThisLot / tx.quantity) * proceeds;
                    
                    const disposal = {
                        id: appData.disposals.length + 1,
                        saleId: tx.id,
                        lotId: lot.id,
                        saleDate: tx.date,
                        acquiredDate: lot.date,
                        coin: tx.coin,
                        quantity: qtyFromThisLot,
                        proceeds: proceedsFromThisLot,
                        costBasis: costBasis,
                        gainLoss: proceedsFromThisLot - costBasis,
                        daysHeld: Math.floor((new Date(tx.date) - new Date(lot.date)) / (1000 * 60 * 60 * 24)),
                        term: Math.floor((new Date(tx.date) - new Date(lot.date)) / (1000 * 60 * 60 * 24)) > 365 ? 'Long-Term' : 'Short-Term'
                    };
                    appData.disposals.push(disposal);
                    
                    lot.qtySold += qtyFromThisLot;
                    lot.remaining -= qtyFromThisLot;
                    lot.status = lot.remaining === 0 ? 'Depleted' : 'Partial';
                    
                    qtyToSell -= qtyFromThisLot;
                }
                
                if (qtyToSell > 0.00000001) {
                    alert(`‚ö†Ô∏è Warning: Not enough ${tx.coin} in lots to cover sale of ${tx.quantity.toFixed(8)}.\n\nRemaining unmatched: ${qtyToSell.toFixed(8)}`);
                }
            }
        }

        // Update all tables
        function updateAllTables() {
            updateTransactionsTable();
            updateLotsTable();
            updateDisposalsTable();
            document.getElementById('transactionCount').textContent = appData.transactions.length;
        }

        function updateTransactionsTable() {
            const tbody = document.getElementById('transactionsBody');
            const emptyState = document.getElementById('transactionsEmpty');
            
            if (appData.transactions.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            tbody.innerHTML = '';
            
            appData.transactions.forEach(tx => {
                const row = tbody.insertRow();
                const typeColor = tx.type.includes('Buy') || tx.type.includes('Income') ? 'var(--accent-green)' : 
                                 tx.type.includes('Sell') ? 'var(--accent-red)' : 'var(--accent-blue)';
                
                row.innerHTML = `
                    <td style="font-weight: bold;">#${tx.id}</td>
                    <td>${tx.date}</td>
                    <td><span style="color: ${typeColor}; font-weight: 600;">${tx.type}</span></td>
                    <td><span style="font-weight: 600;">${tx.coin}</span></td>
                    <td>${tx.quantity.toFixed(8)}</td>
                    <td style="font-weight: 600;">$${tx.amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>$${tx.fees.toFixed(2)}</td>
                    <td>$${tx.perUnit.toFixed(2)}</td>
                    <td>${tx.exchange}</td>
                    <td style="color: var(--text-secondary);">${tx.notes || '-'}</td>
                    <td><button onclick="deleteTransaction(${tx.id})" class="danger" style="padding: 6px 12px; font-size: 12px;">Delete</button></td>
                `;
            });
        }

        function updateLotsTable() {
            const tbody = document.getElementById('lotsBody');
            tbody.innerHTML = '';
            
            appData.lots.forEach(lot => {
                const currentPrice = appData.currentPrices[lot.coin] || 0;
                const currentValue = lot.remaining * currentPrice;
                const unrealizedPL = currentValue - (lot.remaining * lot.perUnitCost);
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td style="font-weight: 600; color: var(--accent-blue);">${lot.id}</td>
                    <td>${lot.date}</td>
                    <td><span style="font-weight: 600;">${lot.coin}</span></td>
                    <td>${lot.originalQty.toFixed(8)}</td>
                    <td style="font-weight: 600;">$${lot.costBasis.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>$${lot.perUnitCost.toFixed(2)}</td>
                    <td>${lot.qtySold.toFixed(8)}</td>
                    <td style="font-weight: 600;">${lot.remaining.toFixed(8)}</td>
                    <td><span class="status-badge ${lot.status.toLowerCase().replace(' ', '')}">${lot.status}</span></td>
                    <td class="${unrealizedPL >= 0 ? 'positive' : 'negative'}" style="font-weight: 600;">
                        ${lot.remaining > 0 ? '$' + unrealizedPL.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '-'}
                    </td>
                `;
            });
        }

        function updateDisposalsTable() {
            const tbody = document.getElementById('disposalsBody');
            tbody.innerHTML = '';
            
            appData.disposals.forEach(disposal => {
                const row = tbody.insertRow();
                const termColor = disposal.term === 'Long-Term' ? 'var(--accent-green)' : 'var(--accent-yellow)';
                
                row.innerHTML = `
                    <td style="font-weight: bold;">#${disposal.saleId}</td>
                    <td>${disposal.saleDate}</td>
                    <td style="color: var(--accent-blue);">${disposal.lotId}</td>
                    <td>${disposal.acquiredDate}</td>
                    <td><span style="font-weight: 600;">${disposal.coin}</span></td>
                    <td>${disposal.quantity.toFixed(8)}</td>
                    <td style="font-weight: 600;">$${disposal.proceeds.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>$${disposal.costBasis.toFixed(2)}</td>
                    <td class="${disposal.gainLoss >= 0 ? 'positive' : 'negative'}" style="font-weight: bold;">
                        $${disposal.gainLoss.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </td>
                    <td>${disposal.daysHeld}</td>
                    <td style="color: ${termColor}; font-weight: 600;">${disposal.term}</td>
                `;
            });
        }

        // Update lot statistics
        function updateLotStats() {
            const totalLots = appData.lots.length;
            const activeLots = appData.lots.filter(l => l.status !== 'Depleted').length;
            const depletedLots = appData.lots.filter(l => l.status === 'Depleted').length;
            const totalCostBasis = appData.lots
                .filter(l => l.remaining > 0)
                .reduce((sum, l) => sum + (l.remaining * l.perUnitCost), 0);
            
            document.getElementById('totalLots').textContent = totalLots;
            document.getElementById('activeLots').textContent = activeLots;
            document.getElementById('depletedLots').textContent = depletedLots;
            document.getElementById('totalCostBasis').textContent = '$' + totalCostBasis.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
        }

        // Update disposal statistics
        function updateDisposalStats() {
            const totalSales = appData.disposals.length;
            const totalProceeds = appData.disposals.reduce((sum, d) => sum + d.proceeds, 0);
            const gains = appData.disposals.filter(d => d.gainLoss > 0).reduce((sum, d) => sum + d.gainLoss, 0);
            const losses = Math.abs(appData.disposals.filter(d => d.gainLoss < 0).reduce((sum, d) => sum + d.gainLoss, 0));
            
            document.getElementById('totalSales').textContent = totalSales;
            document.getElementById('totalProceeds').textContent = '$' + totalProceeds.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
            document.getElementById('totalGains').textContent = '$' + gains.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
            document.getElementById('totalLosses').textContent = '$' + losses.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
        }

        // Update summary
        function updateSummary() {
            const currentYear = appData.metadata.taxYear;
            const yearDisposals = appData.disposals.filter(d => new Date(d.saleDate).getFullYear() === currentYear);
            
            const shortTermGains = yearDisposals
                .filter(d => d.term === 'Short-Term')
                .reduce((sum, d) => sum + d.gainLoss, 0);
                
            const longTermGains = yearDisposals
                .filter(d => d.term === 'Long-Term')
                .reduce((sum, d) => sum + d.gainLoss, 0);
            
            const incomeTransactions = appData.transactions.filter(tx => 
                ['Income', 'Mining', 'Staking', 'Airdrop'].includes(tx.type) &&
                new Date(tx.date).getFullYear() === currentYear
            );
            const totalIncome = incomeTransactions.reduce((sum, tx) => sum + tx.amount, 0);
            
            const shortTermTax = Math.max(0, shortTermGains * (appData.settings.shortTermRate / 100));
            const longTermTax = Math.max(0, longTermGains * (appData.settings.longTermRate / 100));
            const incomeTax = totalIncome * (appData.settings.shortTermRate / 100);
            const stateTax = (Math.max(0, shortTermGains + longTermGains) + totalIncome) * (appData.settings.stateRate / 100);
            const taxLiability = shortTermTax + longTermTax + incomeTax + stateTax;
            
            document.getElementById('shortTermGains').textContent = `$${shortTermGains.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('longTermGains').textContent = `$${longTermGains.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('totalIncome').textContent = `$${totalIncome.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('taxLiability').textContent = `$${taxLiability.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            
            document.getElementById('stRateDisplay').textContent = appData.settings.shortTermRate + '%';
            document.getElementById('ltRateDisplay').textContent = appData.settings.longTermRate + '%';
            
            updateHoldingsTable();
            updatePriceSettings();
        }

        function updateHoldingsTable() {
            const tbody = document.getElementById('holdingsBody');
            tbody.innerHTML = '';
            
            const holdings = {};
            
            appData.lots.forEach(lot => {
                if (lot.remaining > 0) {
                    if (!holdings[lot.coin]) {
                        holdings[lot.coin] = {
                            quantity: 0,
                            totalCost: 0
                        };
                    }
                    holdings[lot.coin].quantity += lot.remaining;
                    holdings[lot.coin].totalCost += lot.remaining * lot.perUnitCost;
                }
            });
            
            Object.keys(holdings).forEach(coin => {
                const holding = holdings[coin];
                const avgCost = holding.totalCost / holding.quantity;
                const currentPrice = appData.currentPrices[coin] || 0;
                const currentValue = holding.quantity * currentPrice;
                const unrealizedPL = currentValue - holding.totalCost;
                const percentChange = holding.totalCost > 0 ? ((currentValue - holding.totalCost) / holding.totalCost * 100) : 0;
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td style="font-weight: bold;">${coin}</td>
                    <td>${holding.quantity.toFixed(8)}</td>
                    <td>$${avgCost.toFixed(2)}</td>
                    <td>$${holding.totalCost.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>$${currentPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td style="font-weight: bold;">$${currentValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="${unrealizedPL >= 0 ? 'positive' : 'negative'}" style="font-weight: bold;">
                        $${unrealizedPL.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                    </td>
                    <td class="${percentChange >= 0 ? 'positive' : 'negative'}" style="font-weight: bold;">
                        ${percentChange >= 0 ? '+' : ''}${percentChange.toFixed(2)}%
                    </td>
                `;
            });
            
            if (Object.keys(holdings).length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `<td colspan="8" style="text-align: center; color: var(--text-secondary); padding: 40px;">No current holdings</td>`;
            }
        }

        function updatePriceSettings() {
            const container = document.getElementById('priceSettings');
            container.innerHTML = '';
            
            Object.keys(appData.currentPrices).forEach(coin => {
                const div = document.createElement('div');
                div.innerHTML = `
                    <div class="form-group">
                        <label>${coin}</label>
                        <input type="number" value="${appData.currentPrices[coin]}" 
                               onchange="updatePrice('${coin}', this.value)" 
                               step="0.01" min="0">
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updatePrice(coin, value) {
            appData.currentPrices[coin] = parseFloat(value);
            updateSummary();
            updateLotsTable();
            saveToLocalStorage();
        }

        // Delete transaction
        function deleteTransaction(id) {
            if (confirm('‚ö†Ô∏è Delete Transaction #' + id + '?\n\nThis will recalculate all lots and disposals.')) {
                appData.transactions = appData.transactions.filter(tx => tx.id !== id);
                recalculateAll();
            }
        }

        // Recalculate all
        function recalculateAll() {
            appData.lots = [];
            appData.disposals = [];
            
            appData.transactions.forEach(tx => {
                processTransaction(tx);
            });
            
            updateAllTables();
            updateSummary();
            saveToLocalStorage();
        }

        // Clear all data
        function clearAllData() {
            if (confirm('‚ö†Ô∏è DELETE ALL DATA?\n\nThis will permanently remove all transactions, lots, and calculations.\n\nThis cannot be undone!')) {
                if (confirm('Are you absolutely sure? Consider exporting your data first.')) {
                    appData.transactions = [];
                    appData.lots = [];
                    appData.disposals = [];
                    updateAllTables();
                    updateSummary();
                    saveToLocalStorage();
                }
            }
        }

        // Save settings
        function saveSettings() {
            appData.settings.shortTermRate = parseFloat(document.getElementById('shortTermRate').value);
            appData.settings.longTermRate = parseFloat(document.getElementById('longTermRate').value);
            appData.settings.stateRate = parseFloat(document.getElementById('stateRate').value);
            appData.settings.costBasisMethod = document.getElementById('costBasisMethod').value;
            
            recalculateAll();
            alert('‚úÖ Settings saved and calculations updated!');
        }

        // Import/Export Functions
        function exportToJSON() {
            appData.metadata.lastModified = new Date().toISOString();
            appData.metadata.exportDate = new Date().toISOString();
            
            const dataStr = JSON.stringify(appData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `crypto-tax-data-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate the data structure
                    if (!importedData.version || !importedData.transactions || !importedData.lots) {
                        throw new Error('Invalid data format');
                    }
                    
                    // Confirm import
                    const txCount = importedData.transactions.length;
                    const lastMod = importedData.metadata?.lastModified ? 
                        new Date(importedData.metadata.lastModified).toLocaleDateString() : 'Unknown';
                    
                    if (confirm(`üìÇ Import Data?\n\nFile contains:\n‚Ä¢ ${txCount} transactions\n‚Ä¢ Last modified: ${lastMod}\n\nThis will REPLACE all current data.`)) {
                        appData = importedData;
                        
                        // Update settings display
                        document.getElementById('shortTermRate').value = appData.settings.shortTermRate;
                        document.getElementById('longTermRate').value = appData.settings.longTermRate;
                        document.getElementById('stateRate').value = appData.settings.stateRate;
                        document.getElementById('costBasisMethod').value = appData.settings.costBasisMethod;
                        
                        updateAllTables();
                        updateSummary();
                        saveToLocalStorage();
                        
                        alert('‚úÖ Data imported successfully!');
                    }
                } catch (error) {
                    alert('‚ùå Error importing file: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Reset the input
            event.target.value = '';
        }

        function exportToCSV() {
            let csv = '=== CRYPTO TAX REPORT ===\n';
            csv += `Generated: ${new Date().toLocaleString()}\n`;
            csv += `Tax Year: ${appData.metadata.taxYear}\n\n`;
            
            // Transaction History
            csv += '=== TRANSACTION HISTORY ===\n';
            csv += 'ID,Date,Type,Coin,Quantity,USD Amount,Fees,Per Unit,Exchange,Notes\n';
            
            appData.transactions.forEach(tx => {
                csv += `${tx.id},${tx.date},${tx.type},${tx.coin},${tx.quantity},${tx.amount},${tx.fees},${tx.perUnit},"${tx.exchange}","${tx.notes || ''}"\n`;
            });
            
            // Form 8949 - Short Term
            csv += '\n\n=== FORM 8949 - SHORT TERM CAPITAL GAINS ===\n';
            csv += 'Description,Date Acquired,Date Sold,Proceeds,Cost Basis,Gain/Loss\n';
            
            const shortTermDisposals = appData.disposals.filter(d => d.term === 'Short-Term');
            shortTermDisposals.forEach(d => {
                csv += `${d.quantity.toFixed(8)} ${d.coin},${d.acquiredDate},${d.saleDate},${d.proceeds.toFixed(2)},${d.costBasis.toFixed(2)},${d.gainLoss.toFixed(2)}\n`;
            });
            
            const shortTermTotal = shortTermDisposals.reduce((sum, d) => sum + d.gainLoss, 0);
            csv += `,,TOTAL:,,,${shortTermTotal.toFixed(2)}\n`;
            
            // Form 8949 - Long Term
            csv += '\n\n=== FORM 8949 - LONG TERM CAPITAL GAINS ===\n';
            csv += 'Description,Date Acquired,Date Sold,Proceeds,Cost Basis,Gain/Loss\n';
            
            const longTermDisposals = appData.disposals.filter(d => d.term === 'Long-Term');
            longTermDisposals.forEach(d => {
                csv += `${d.quantity.toFixed(8)} ${d.coin},${d.acquiredDate},${d.saleDate},${d.proceeds.toFixed(2)},${d.costBasis.toFixed(2)},${d.gainLoss.toFixed(2)}\n`;
            });
            
            const longTermTotal = longTermDisposals.reduce((sum, d) => sum + d.gainLoss, 0);
            csv += `,,TOTAL:,,,${longTermTotal.toFixed(2)}\n`;
            
            // Income Summary
            csv += '\n\n=== CRYPTO INCOME SUMMARY ===\n';
            csv += 'Date,Type,Coin,Quantity,USD Value\n';
            
            const incomeTransactions = appData.transactions.filter(tx => 
                ['Income', 'Mining', 'Staking', 'Airdrop'].includes(tx.type)
            );
            
            incomeTransactions.forEach(tx => {
                csv += `${tx.date},${tx.type},${tx.coin},${tx.quantity},${tx.amount}\n`;
            });
            
            const totalIncome = incomeTransactions.reduce((sum, tx) => sum + tx.amount, 0);
            csv += `,,TOTAL:,,${totalIncome.toFixed(2)}\n`;
            
            // Tax Summary
            csv += '\n\n=== TAX LIABILITY SUMMARY ===\n';
            csv += `Short-Term Capital Gains:,$${shortTermTotal.toFixed(2)}\n`;
            csv += `Long-Term Capital Gains:,$${longTermTotal.toFixed(2)}\n`;
            csv += `Crypto Income:,$${totalIncome.toFixed(2)}\n`;
            csv += `Short-Term Tax Rate:,${appData.settings.shortTermRate}%\n`;
            csv += `Long-Term Tax Rate:,${appData.settings.longTermRate}%\n`;
            csv += `State Tax Rate:,${appData.settings.stateRate}%\n`;
            
            const shortTermTax = Math.max(0, shortTermTotal * (appData.settings.shortTermRate / 100));
            const longTermTax = Math.max(0, longTermTotal * (appData.settings.longTermRate / 100));
            const incomeTax = totalIncome * (appData.settings.shortTermRate / 100);
            const stateTax = (Math.max(0, shortTermTotal + longTermTotal) + totalIncome) * (appData.settings.stateRate / 100);
            const totalTax = shortTermTax + longTermTax + incomeTax + stateTax;
            
            csv += `\nEstimated Federal Tax:,$${(shortTermTax + longTermTax + incomeTax).toFixed(2)}\n`;
            csv += `Estimated State Tax:,$${stateTax.toFixed(2)}\n`;
            csv += `TOTAL ESTIMATED TAX:,$${totalTax.toFixed(2)}\n`;
            
            // Download file
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `crypto-tax-report-${appData.metadata.taxYear}-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Local Storage Functions
        function saveToLocalStorage() {
            try {
                appData.metadata.lastModified = new Date().toISOString();
                localStorage.setItem('cryptoTaxTrackerPro', JSON.stringify(appData));
            } catch (e) {
                console.error('Failed to save to localStorage:', e);
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('cryptoTaxTrackerPro');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    // Ensure backward compatibility
                    if (parsed.version) {
                        appData = parsed;
                    } else {
                        // Old format - migrate
                        appData.transactions = parsed.transactions || [];
                        appData.lots = parsed.lots || [];
                        appData.disposals = parsed.disposals || [];
                        appData.settings = parsed.settings || appData.settings;
                        appData.currentPrices = parsed.currentPrices || appData.currentPrices;
                    }
                    
                    // Update settings display
                    document.getElementById('shortTermRate').value = appData.settings.shortTermRate;
                    document.getElementById('longTermRate').value = appData.settings.longTermRate;
                    document.getElementById('stateRate').value = appData.settings.stateRate;
                    document.getElementById('costBasisMethod').value = appData.settings.costBasisMethod;
                } else {
                    // Load sample data for demo
                    loadSampleData();
                }
            } catch (e) {
                console.error('Failed to load from localStorage:', e);
                loadSampleData();
            }
        }

        // Sample data for demo
        function loadSampleData() {
            const sampleTransactions = [
                {
                    id: 1,
                    date: '2024-01-15',
                    timestamp: '2024-01-15T10:00:00Z',
                    type: 'Buy',
                    coin: 'BTC',
                    quantity: 0.5,
                    amount: 20000,
                    fees: 50,
                    perUnit: 40100,
                    exchange: 'Coinbase',
                    notes: 'Initial investment'
                },
                {
                    id: 2,
                    date: '2024-03-10',
                    timestamp: '2024-03-10T14:00:00Z',
                    type: 'Buy',
                    coin: 'ETH',
                    quantity: 10,
                    amount: 25000,
                    fees: 30,
                    perUnit: 2503,
                    exchange: 'Binance',
                    notes: 'DCA purchase'
                },
                {
                    id: 3,
                    date: '2024-06-20',
                    timestamp: '2024-06-20T16:00:00Z',
                    type: 'Sell',
                    coin: 'BTC',
                    quantity: 0.3,
                    amount: 18000,
                    fees: 40,
                    perUnit: 59866,
                    exchange: 'Coinbase',
                    notes: 'Partial profit taking'
                },
                {
                    id: 4,
                    date: '2024-07-15',
                    timestamp: '2024-07-15T12:00:00Z',
                    type: 'Staking',
                    coin: 'ETH',
                    quantity: 0.5,
                    amount: 1500,
                    fees: 0,
                    perUnit: 3000,
                    exchange: 'Coinbase',
                    notes: 'Monthly staking reward'
                }
            ];
            
            appData.transactions = [];
            appData.lots = [];
            appData.disposals = [];
            
            sampleTransactions.forEach(tx => {
                appData.transactions.push(tx);
                processTransaction(tx);
            });
            
            saveToLocalStorage();
        }
    </script>
</body>
</html>